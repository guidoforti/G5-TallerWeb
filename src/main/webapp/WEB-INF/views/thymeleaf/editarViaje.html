<!DOCTYPE HTML>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/fragments :: head('UnRumbo - Editar Viaje')">
    <th:block th:fragment="extra">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    </th:block>
</head>

<body>
<nav th:replace="fragments/fragments :: navbar"></nav>

<main role="main" class="container" style="margin-top: 100px;">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold text-dark">Editar Viaje</h4>
                        <p class="text-muted">Modificá los datos de tu viaje</p>
                    </div>

                    <!-- Mensaje de error -->
                    <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

                    <form th:action="@{/viaje/editar}" th:object="${viaje}" method="post" class="needs-validation" novalidate>
                        <input type="hidden" th:field="*{id}">

                        <div class="row mb-4">
                            <!-- Ciudad Origen -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ciudad Origen</label>
                                <select th:field="*{nombreCiudadOrigen}"
                                        class="form-control"
                                        required>
                                    <option th:value="*{nombreCiudadOrigen}" th:text="*{nombreCiudadOrigen}" selected></option>
                                </select>
                                <div class="invalid-feedback">Por favor ingrese la ciudad de origen</div>
                            </div>

                            <!-- Ciudad Destino -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ciudad Destino</label>
                                <select th:field="*{nombreCiudadDestino}"
                                        class="form-control"
                                        required>
                                    <option th:value="*{nombreCiudadDestino}" th:text="*{nombreCiudadDestino}" selected></option>
                                </select>
                                <div class="invalid-feedback">Por favor ingrese la ciudad de destino</div>
                            </div>
                        </div>

                        <!-- Vehículo -->
                        <div class="mb-4">
                            <label class="form-label">Vehículo</label>
                            <select th:field="*{vehiculoId}"
                                    class="form-select"
                                    required>
                                <option value="">Seleccionar vehículo</option>
                                <option th:each="v : ${vehiculos}"
                                        th:value="${v.id}"
                                        th:text="${v.anio} + ' ' + ${v.modelo} + ' (' + ${v.patente} + ')'">
                                </option>
                            </select>
                            <div class="invalid-feedback">Por favor seleccione un vehículo</div>
                        </div>

                        <div class="row mb-4">
                            <!-- Fecha y Hora -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha y Hora de Salida</label>
                                <input type="datetime-local"
                                       class="form-control"
                                       th:field="*{fechaHoraDeSalida}"
                                       required>
                                <div class="invalid-feedback">Por favor ingrese la fecha y hora de salida</div>
                            </div>

                            <!-- Precio -->
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Precio</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number"
                                           class="form-control"
                                           th:field="*{precio}"
                                           step="0.01"
                                           min="1"
                                           required>
                                </div>
                                <div class="invalid-feedback">Por favor ingrese un precio válido</div>
                            </div>

                            <!-- Asientos -->
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Asientos Disponibles</label>
                                <input type="number"
                                       class="form-control"
                                       th:field="*{asientosDisponibles}"
                                       min="1"
                                       required>
                                <div class="invalid-feedback">Por favor ingrese la cantidad de asientos</div>
                            </div>
                        </div>

                        <!-- Paradas Intermedias -->
                        <div class="mb-4">
                            <label class="form-label">Paradas Intermedias</label>
                            <div id="paradasContainer" class="mb-2">
                            </div>
                            <button type="button"
                                    id="btnAgregarParada"
                                    class="btn btn-outline-secondary">
                                <i class="bi bi-plus-circle"></i> Agregar Parada
                            </button>
                            <small class="form-text text-muted d-block mt-1">
                                Agregá ciudades intermedias en el orden que las visitarás
                            </small>
                            <input type="hidden" id="paradasIniciales" th:value="${#strings.arrayJoin(viaje.nombreParadas.toArray(), '||')}">
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a th:href="@{/viaje/listar}" class="btn btn-outline-secondary me-md-2">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Bootstrap core js -->
<script th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.bundle.min.js}"></script>
<script>
    function getTomSelectConfig() {
        return {
            valueField: 'text',
            labelField: 'text',
            searchField: 'text',
            create: false,
            loadThrottle: 300,
            placeholder: 'Escribí para buscar...',
            preload: false,
            shouldLoad: function(query) {
                return query.length >= 2;
            },
            load: function(query, callback) {
                const url = `/spring/api/nominatim/buscar?query=${encodeURIComponent(query)}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const options = data.map(ciudad => ({ text: ciudad, value: ciudad }));
                        callback(options);
                    })
                    .catch(error => {
                        console.error('Error al buscar ciudades:', error);
                        callback();
                    });
            },
            render: {
                no_results: function() {
                    return '<div class="no-results">No se encontraron ciudades</div>';
                }
            }
        };
    }

    function setupTomSelect(selectId) {
        const selectElement = document.getElementById(selectId);

        if (!selectElement) {
            console.error(`No se encontró el elemento select: ${selectId}`);
            return null;
        }
        if (selectElement.tomselect) {
            selectElement.tomselect.destroy();
        }
        try {
            return new TomSelect(`#${selectId}`, getTomSelectConfig());
        } catch (error) {
            console.error(`Error al inicializar Tom Select en ${selectId}:`, error);
            return null;
        }
    }
    const tomSelectInstances = new Map();

    function obtenerCantidadParadas() {
        return document.getElementById('paradasContainer').querySelectorAll('select.parada-input-select').length;
    }

    function agregarParada(initialValue = null) {
        const container = document.getElementById('paradasContainer');

        if (!container) {
            console.error('No se encontró el container de paradas');
            return;
        }

        const index = obtenerCantidadParadas();
        const uniqueId = `parada-input-${index}-${Date.now()}`;

        const paradaDiv = document.createElement('div');
        paradaDiv.className = 'parada-item input-group mb-2';
        paradaDiv.id = `parada-${uniqueId}`;

        paradaDiv.innerHTML = `
            <div class="flex-grow-1">
                <select id="${uniqueId}"
                        name="nombreParadas[${index}]"
                        class="form-control parada-input-select"
                        placeholder="Escribí para buscar..."
                        required>
                    ${initialValue ? `<option value="${initialValue}" selected>${initialValue}</option>` : ''}
                </select>
            </div>
            <button type="button"
                    class="btn btn-outline-danger"
                    data-unique-id="${uniqueId}"
                    onclick="eliminarParada('${uniqueId}')">
                <i class="bi bi-trash"></i>
            </button>
        `;

        container.appendChild(paradaDiv);

        const tomSelectInstance = setupTomSelect(uniqueId);
        if (tomSelectInstance) {
            tomSelectInstances.set(uniqueId, tomSelectInstance);

            if (initialValue) {
                 tomSelectInstance.addOption({ text: initialValue, value: initialValue });
                 tomSelectInstance.setValue(initialValue);
            }
        }
    }

    function eliminarParada(uniqueId) {
        const paradaDiv = document.getElementById(`parada-${uniqueId}`);

        if (!paradaDiv) {
            return;
        }

        const tomSelectInstance = tomSelectInstances.get(uniqueId);
        if (tomSelectInstance) {
            tomSelectInstance.destroy();
            tomSelectInstances.delete(uniqueId);
        }

        paradaDiv.remove();

        actualizarIndicesParadas();
    }
    function actualizarIndicesParadas() {
        const paradas = document.getElementById('paradasContainer').querySelectorAll('.parada-item');

        paradas.forEach((paradaDiv, index) => {
            const selectElement = paradaDiv.querySelector('select.parada-input-select');

            if (selectElement) {
                selectElement.name = `nombreParadas[${index}]`;
            }
        });
    }
    function cargarParadasExistentes() {
        const paradasInput = document.getElementById('paradasIniciales');
        if (!paradasInput) return;

        const paradasStr = paradasInput.value;

        if (paradasStr) {
            const nombresParadas = paradasStr.split('||');
            nombresParadas.forEach(nombre => {
                if (nombre && nombre.trim() !== '') {
                    agregarParada(nombre.trim());
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
        setupTomSelect('nombreCiudadOrigen');
        setupTomSelect('nombreCiudadDestino');
        cargarParadasExistentes();

        const btnAgregarParada = document.getElementById('btnAgregarParada');
        if (btnAgregarParada) {
            btnAgregarParada.addEventListener('click', () => agregarParada());
        }
    });
</script>
</body>
</html>