<!DOCTYPE HTML>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/fragments :: head('UnRumbo - Home')">
    <th:block th:fragment="extra">
    </th:block>
</head>

<body>
<nav th:replace="fragments/navbar_conductor :: navbar"></nav>

<main role="main" class="container" style="margin-top: 120px;">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h4 class="fw-bold text-dark">隆Bienvenido, <span th:text="${nombreConductor}">Conductor</span>!</h4>
                    <p class="text-muted mt-3">Nos alegra verte nuevamente en UnRumbo.</p>

                    <a th:href="@{/viaje/publicar}" class="btn btn-primary w-100 fw-bold mt-3">Publicar viaje</a>

                    <hr class="my-4">

                    <a th:href="@{/viaje/listar}" class="btn btn-dark w-100 fw-bold mt-3">Mis viajes</a>

                    <a th:href="@{/vehiculos/listarVehiculos}" class="btn btn-dark w-100 fw-bold mt-3">Ver veh铆culos</a>

                    <a th:href="@{/reserva/misReservas}" class="btn btn-dark w-100 fw-bold mt-3">Ver mis Reservas</a>

                    <a th:href="@{/logout}" class="btn btn-danger w-100 fw-bold mt-4">Cerrar sesi贸n</a>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="fragments/fragments :: footer"></div>
<script th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.bundle.min.js}"></script>
<script>
    /**
     * Script para el sistema de notificaciones por Polling.
     * Se ejecuta inmediatamente al cargar el fragmento.
     */

    const API_URL = '/spring/api/notificaciones/pendientes';
    const POLLING_INTERVAL = 10000; // 10 segundos

    // Elementos del DOM (Ya deben existir en la Navbar)
    const notificationCounter = document.getElementById('notificacion-contador');

    function mostrarToastNotificacion(notif) {
        console.log(`[NOTIF] ${notif.mensaje}`);

        // Simulaci贸n de Toast con confirmaci贸n para la redirecci贸n
        const isConfirmed = confirm(`隆NUEVA NOTIFICACIN! ${notif.mensaje}\n\n驴Ir a detalles?`);

        if (isConfirmed && notif.urlDestino) {
            window.location.href = notif.urlDestino;
        }
    }

    function actualizarContador(count) {
        if (notificationCounter) {
            if (count > 0) {
                notificationCounter.textContent = count;
                notificationCounter.style.display = 'inline-block';
            } else {
                notificationCounter.textContent = 0;
                notificationCounter.style.display = 'none';
            }
        }
    }

    function checkNotifications() {
        // Ejecutamos fetch. El backend debe devolver 401 si la sesi贸n es inv谩lida.
        fetch(API_URL)
            .then(response => {
                if (response.status === 401) {
                    throw new Error("UNAUTHORIZED");
                }
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(notificaciones => {
                // Si recibimos notificaciones, procesamos y mostramos la m谩s reciente
                if (notificaciones.length > 0) {
                    mostrarToastNotificacion(notificaciones[0]);
                }
                // Actualizar el badge con el total de notificaciones no vistas
                actualizarContador(notificaciones.length);
            })
            .catch(error => {
                if (error.message === "UNAUTHORIZED") {
                    console.warn("Polling detenido: Sesi贸n expirada.");
                    // Opcional: Podr铆as redirigir a /login aqu铆 si la sesi贸n es cr铆tica: window.location.href = '/spring/login';
                } else {
                    console.error("Error de Polling:", error);
                }
            });
    }

    // [ INICIO]: Funci贸n para iniciar el Polling
    function iniciarPolling() {
        checkNotifications(); // Primera comprobaci贸n inmediata
        setInterval(checkNotifications, POLLING_INTERVAL); // Repetici贸n
    }

    // Disparar el Polling Inmediatamente (ya que estamos en un fragmento condicional)
    iniciarPolling();
</script>
</body>
</html>